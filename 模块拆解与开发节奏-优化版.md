# SmallDY 模块拆解与开发节奏（优化版）

## 📋 文档说明

本文档基于技术设计文档优化版，提供更详细、更合理的模块拆解和开发节奏规划。

---

## 一、模块拆解（优化版）

### 1. 基础架构模块
**目标**：搭建稳定的应用骨架，为后续开发奠定基础

**包含内容：**
- ✅ Navigation Compose 导航架构
- ✅ Tab 导航（顶部和底部）
- ✅ SharedElement 转场动画基础
- ✅ MVVM 架构搭建
- ✅ 依赖注入配置（ViewModel）
- ✅ 主题和样式系统

**技术要点：**
- 使用 Navigation Compose 2.9.6
- 使用 Compose Foundation 的 HorizontalPager 实现 Tab 切换
- 使用 SharedTransitionLayout 实现转场动画
- 使用 `viewModel()` 或 Hilt 进行依赖注入

---

### 2. 数据层模块
**目标**：建立数据模型和 Mock 数据源

**包含内容：**
- ✅ 数据模型定义（VideoData、UserData、CommentData、ChatMessage）
- ✅ Mock 数据源实现
- ✅ Repository 接口定义
- ✅ 数据转换工具类

**技术要点：**
- 使用 Kotlin Data Class
- 使用本地资源（raw 文件夹）作为 Mock 数据
- 使用 Flow/StateFlow 进行数据流管理

---

### 3. 可复用组件模块
**目标**：构建可在多个页面复用的通用组件

**包含内容：**
- ✅ FeedCard（瀑布流卡片组件）
- ✅ VideoIntroCard（视频简介卡片）
- ✅ 互动小组件：
  - LikeButton（点赞按钮，带动画）
  - CommentButton（评论按钮）
  - ShareButton（分享按钮）
  - FollowButton（关注按钮）
- ✅ UserAvatar（用户头像组件）
- ✅ LoadingIndicator（加载指示器）
- ✅ ErrorView（错误视图）

**技术要点：**
- 组件设计遵循单一职责原则
- 使用 `@Composable` 函数参数传递数据
- 支持自定义样式和回调
- 使用 `remember` 优化性能

---

### 4. 双列外流页面模块
**目标**：实现类似抖音的瀑布流外流页面

**包含内容：**
- ✅ FeedScreen（主页面）
- ✅ FeedViewModel（状态管理）
- ✅ 双列瀑布流布局（LazyVerticalGrid）
- ✅ 下拉刷新功能（Material3 SwipeRefresh）
- ✅ 上拉加载更多
- ✅ SharedElement 转场动画
- ✅ 顶部 Tab 导航集成

**技术要点：**
- 使用 `LazyVerticalGrid` 实现双列布局
- 使用 `SwipeRefresh` 实现下拉刷新
- 使用 `LazyListState` 监听滚动实现加载更多
- 使用 `SharedTransitionLayout` 实现转场动画
- 图片使用 Coil 加载和缓存

---

### 5. 单列内流页面模块
**目标**：实现全屏视频播放和上下滑动切换

**包含内容：**
- ✅ VideoScreen（视频播放页面）
- ✅ VideoViewModel（视频状态管理）
- ✅ VideoPlayer（ExoPlayer 封装）
- ✅ VerticalPager（上下滑动切换）
- ✅ 播放控制（播放/暂停）
- ✅ 双击点赞动画
- ✅ 音乐转盘动画
- ✅ 视频预加载机制
- ✅ 互动按钮组（点赞、评论、分享）

**技术要点：**
- 使用 Media3 ExoPlayer 播放视频
- 使用 `VerticalPager` 实现上下滑动
- 使用 `Modifier.pointerInput` 检测双击手势
- 使用 `infiniteRepeatable` 实现转盘旋转动画
- 实现视频预加载优化流畅度

---

### 6. 图文评论页面模块
**目标**：实现评论列表和发布评论功能

**包含内容：**
- ✅ CommentScreen（评论页面）
- ✅ CommentViewModel（评论状态管理）
- ✅ CommentItem（评论项组件）
- ✅ CommentInput（评论输入框）
- ✅ 评论列表（LazyColumn）
- ✅ 发布评论功能
- ✅ 评论点赞功能
- ✅ 回复评论功能（可选）

**技术要点：**
- 使用 `LazyColumn` 实现评论列表
- 使用 `TextField` 实现评论输入
- 评论内容支持多行显示
- 新评论自动添加到列表顶部
- 使用 `rememberSaveable` 保存输入状态

---

### 7. AI聊天功能模块
**目标**：实现悬浮球和AI对话功能

**包含内容：**
- ✅ FloatingBall（可拖动的悬浮球）
- ✅ ChatScreen（聊天界面）
- ✅ ChatViewModel（聊天状态管理）
- ✅ MessageItem（消息项组件）
- ✅ ChatInput（聊天输入框）
- ✅ AI 服务集成（API 或本地模型）
- ✅ 流式响应处理（可选）

**技术要点：**
- 使用 `Modifier.draggable` 或 `pointerInput` 实现拖动
- 使用 `BottomSheet` 或 `Dialog` 显示聊天界面
- 集成 AI API（如 OpenAI、本地模型等）
- 实现消息列表的自动滚动
- 使用 `LaunchedEffect` 处理异步响应

---

## 二、开发节奏（优化版）

### 🚀 阶段一：前期搭建（2-3天）

**目标**：建立项目骨架和基础架构

**任务清单：**
1. **依赖配置**（0.5天）
   - [ ] 添加 ExoPlayer (Media3) 依赖
   - [ ] 添加 ViewModel 依赖
   - [ ] 添加 Compose Foundation 依赖
   - [ ] 统一版本号，清理重复依赖

2. **架构搭建**（1天）
   - [ ] 搭建 MVVM 架构基础
   - [ ] 创建 Navigation 结构
   - [ ] 实现 MainNavigation
   - [ ] 创建基础页面路由

3. **导航系统**（1天）
   - [ ] 实现 TopNav（顶部 Tab 导航）
   - [ ] 实现 BottomNav（底部导航）
   - [ ] 使用 HorizontalPager 实现 Tab 切换
   - [ ] 集成到 Scaffold

4. **数据层基础**（0.5天）
   - [ ] 定义数据模型（VideoData、UserData 等）
   - [ ] 创建 MockDataSource
   - [ ] 实现基础 Repository 接口

**验收标准：**
- ✅ 应用可以正常启动
- ✅ 导航结构完整，可以切换 Tab
- ✅ Mock 数据可以正常生成和展示

---

### 🎨 阶段二：外流内容（3-4天）

**目标**：实现双列瀑布流外流页面

**任务清单：**
1. **可复用组件开发**（1.5天）
   - [ ] 优化 FeedCard 组件（已存在，需完善）
   - [ ] 实现互动小组件（LikeButton、CommentButton 等）
   - [ ] 实现 LoadingIndicator
   - [ ] 实现 ErrorView

2. **FeedScreen 实现**（1.5天）
   - [ ] 创建 FeedViewModel
   - [ ] 实现双列布局（LazyVerticalGrid）
   - [ ] 集成 FeedCard 组件
   - [ ] 实现数据加载逻辑

3. **交互功能**（1天）
   - [ ] 实现下拉刷新（SwipeRefresh）
   - [ ] 实现上拉加载更多
   - [ ] 实现点击卡片跳转
   - [ ] 实现 SharedElement 转场动画

**验收标准：**
- ✅ 双列瀑布流正常显示
- ✅ 下拉刷新和上拉加载工作正常
- ✅ 点击卡片可以跳转到视频页面（转场动画流畅）

---

### 🎬 阶段三：内流内容（4-5天）

**目标**：实现全屏视频播放和上下滑动切换

**任务清单：**
1. **ExoPlayer 集成**（1天）
   - [ ] 添加 Media3 ExoPlayer 依赖
   - [ ] 封装 VideoPlayer 组件
   - [ ] 实现播放/暂停控制
   - [ ] 处理播放器生命周期

2. **VerticalPager 实现**（1.5天）
   - [ ] 创建 VideoScreen
   - [ ] 创建 VideoViewModel
   - [ ] 使用 VerticalPager 实现上下滑动
   - [ ] 实现视频切换逻辑

3. **互动功能**（1.5天）
   - [ ] 实现双击点赞动画
   - [ ] 实现音乐转盘动画
   - [ ] 实现互动按钮组（点赞、评论、分享）
   - [ ] 实现用户信息展示

4. **性能优化**（1天）
   - [ ] 实现视频预加载机制
   - [ ] 优化播放器复用
   - [ ] 使用 Surface 优化渲染
   - [ ] 测试滑动流畅度

**验收标准：**
- ✅ 视频可以正常播放
- ✅ 上下滑动切换流畅
- ✅ 双击点赞动画正常
- ✅ 音乐转盘旋转正常
- ✅ 滑动 1-2 屏仍有内容展示

---

### 💬 阶段四：评论列表（2-3天）

**目标**：实现评论列表和发布评论功能

**任务清单：**
1. **评论 UI 开发**（1天）
   - [ ] 创建 CommentScreen
   - [ ] 创建 CommentItem 组件
   - [ ] 实现评论列表（LazyColumn）
   - [ ] 实现评论输入框

2. **评论功能实现**（1天）
   - [ ] 创建 CommentViewModel
   - [ ] 实现加载评论列表
   - [ ] 实现发布评论功能
   - [ ] 实现评论点赞功能

3. **优化和完善**（0.5-1天）
   - [ ] 实现评论高度自适应
   - [ ] 新评论自动置顶
   - [ ] 优化评论列表性能
   - [ ] 添加加载状态和错误处理

**验收标准：**
- ✅ 评论列表正常显示
- ✅ 可以发布新评论
- ✅ 新评论自动显示在顶部
- ✅ 评论内容自适应高度

---

### 🤖 阶段五：AI功能实现（3-4天）

**目标**：实现悬浮球和AI聊天功能

**任务清单：**
1. **悬浮球实现**（1天）
   - [ ] 创建 FloatingBall 组件
   - [ ] 实现拖动功能
   - [ ] 实现边界检测和吸附
   - [ ] 集成到全局布局

2. **聊天界面开发**（1天）
   - [ ] 创建 ChatScreen
   - [ ] 创建 MessageItem 组件
   - [ ] 实现消息列表
   - [ ] 实现输入框和发送按钮

3. **AI 服务集成**（1-2天）
   - [ ] 创建 ChatViewModel
   - [ ] 集成 AI API（或本地模型）
   - [ ] 实现消息发送和接收
   - [ ] 实现流式响应（可选）

**验收标准：**
- ✅ 悬浮球可以拖动
- ✅ 点击悬浮球可以打开聊天界面
- ✅ 可以发送消息并收到 AI 回复
- ✅ 消息列表自动滚动

---

### ✨ 阶段六：体验优化（2-3天）

**目标**：根据实际使用情况优化用户体验

**任务清单：**
1. **性能优化**（1天）
   - [ ] 优化图片加载和缓存
   - [ ] 优化视频预加载策略
   - [ ] 优化列表滚动性能
   - [ ] 减少不必要的重组

2. **UI/UX 优化**（1天）
   - [ ] 统一视觉风格
   - [ ] 优化动画效果
   - [ ] 优化交互反馈
   - [ ] 添加加载和错误状态

3. **细节完善**（0.5-1天）
   - [ ] 处理边界情况
   - [ ] 添加空状态提示
   - [ ] 优化错误提示
   - [ ] 完善无障碍支持

**验收标准：**
- ✅ 应用运行流畅，无明显卡顿
- ✅ UI 风格统一美观
- ✅ 交互反馈及时准确
- ✅ 错误处理完善

---

### 🔧 阶段七：最终优化（1-2天）

**目标**：全面测试和最终优化

**任务清单：**
1. **测试**（0.5-1天）
   - [ ] 功能测试
   - [ ] 性能测试
   - [ ] 兼容性测试
   - [ ] 边界情况测试

2. **Bug 修复**（0.5-1天）
   - [ ] 修复发现的 Bug
   - [ ] 优化异常处理
   - [ ] 完善日志记录

3. **文档完善**（可选）
   - [ ] 更新 README
   - [ ] 添加代码注释
   - [ ] 整理开发文档

**验收标准：**
- ✅ 所有功能正常工作
- ✅ 无明显 Bug
- ✅ 性能满足要求
- ✅ 代码质量良好

---

## 三、开发建议

### 1. 开发顺序建议
- **先基础后功能**：先搭建好架构，再实现具体功能
- **先简单后复杂**：先实现基础功能，再添加高级特性
- **先核心后边缘**：先实现核心功能，再完善细节

### 2. 技术选型建议
- **优先使用官方库**：Compose Foundation、Material3 等
- **避免过时库**：不再使用已被官方吸收的 Accompanist 组件
- **版本统一**：确保所有依赖版本一致

### 3. 代码质量建议
- **遵循 MVVM 架构**：保持清晰的职责分离
- **组件化开发**：提高代码复用性
- **性能优化**：使用 `remember`、`derivedStateOf` 等优化重组
- **错误处理**：完善异常处理和用户提示

### 4. 测试建议
- **单元测试**：为 ViewModel 编写单元测试
- **UI 测试**：为关键交互编写 UI 测试
- **性能测试**：定期测试应用性能
- **真机测试**：在不同设备上测试

---

## 四、风险与应对

### 1. 技术风险
- **风险**：SharedElement 转场动画实现复杂
- **应对**：先实现基础转场，再优化动画效果

### 2. 性能风险
- **风险**：视频列表可能导致内存问题
- **应对**：实现视频预加载和播放器复用机制

### 3. 时间风险
- **风险**：开发时间可能超出预期
- **应对**：优先实现核心功能，非核心功能可以简化或延后

---

## 五、里程碑

| 阶段 | 预计时间 | 关键交付物 |
|------|---------|-----------|
| 阶段一 | 2-3天 | 基础架构、导航系统 |
| 阶段二 | 3-4天 | 双列外流页面 |
| 阶段三 | 4-5天 | 视频内流页面 |
| 阶段四 | 2-3天 | 评论系统 |
| 阶段五 | 3-4天 | AI 聊天功能 |
| 阶段六 | 2-3天 | 体验优化 |
| 阶段七 | 1-2天 | 最终优化 |
| **总计** | **17-24天** | **完整应用** |

---

**文档版本**：v2.0（优化版）  
**最后更新**：2024年12月  
**基于**：技术设计文档-优化版

